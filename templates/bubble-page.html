{% extends 'base.html' %}
{% block content %}

<style type="text/css">
  /*to be changed later*/
  text {
    font: 12px sans-serif;

  }
  circle {
      stroke: #636363;
      stroke-width: 1;
      opacity: 1;
  }
  div.tooltip{
    /*visibility:hidden;*/
    position: absolute;
    color: white;
    padding: 8px;
    background-color: #626D71;
    border-radius: 6px;
    text-align: center;
    font-family: monospace; 
    width: 200px;
  }
  .svg{
    background-color: #D9D9D9;
  }
</style>

  <nav class="navbar navbar-light bg-faded">
  <a class="navbar-brand" href="/">FlickrMatch</a>
  </nav>

  <div class='container'>
  <div id='matchScore' 
  data-username1='{{ username1 }}' 
  data-username2= '{{ username2 }}'
  data-name1 = '{{ name1 }}'
  data-name2 = '{{ name2 }}' 
  data-matchscore='{{ match_tags}}'>
  </div>
  <div id='match'><h4>{{ name1 }} and {{ name2 }} is {{ match_tags }} match in photo tags</h4></div>
  <div>
    <select id='text-source'>
      <option value='tags'>Photo Tags</option>
      <option value='title'>Photo Title</option>
      <option value='description'>Photo Description</option>
    </select>
  </div>

  <div id='graph'></div>
  
    <button> See Recommendation </button>
    <div id='recommendation'></div>
  </div>

  <a href="geo?username1={{ username1 }}&username2={{ username2 }}&name1={{ name1 }}&name2={{ name2 }}"> Location </a><br>
</div>


<script>

  function updateGraph() {
    var username1 = $('#matchScore').data('username1');
    var username2 = $('#matchScore').data('username2');
    var name1 = $('#matchScore').data('name1');
    var name2 = $('#matchScore').data('name2');

    var url = '/tags-bubble';

    if ($('#text-source').val() == 'tags') {
      $.post(url, {'username1': username1,'username2': username2}, function(results){
        // console.log(results)
        var matchscore = results.match_tags;
        $('#match').html('<h3>' + name1 + ' and ' + name2 + ' is ' + matchscore  +' match in photo tags' + '</h3>');
        d3.select("svg").remove();
        updateBubble("static/tags.csv");
      });
    }

    if ($('#text-source').val() == 'title') {
      console.log("clicked");
      $.post(url, {'username1': username1,'username2': username2},function(results){
        var matchscore = results.match_title;
        $('#match').html('<h3>' + name1 + ' and ' + name2 + ' is ' + matchscore  +' match in photo title' + '</h3>');
        d3.select("svg").remove();
        updateBubble("static/title.csv");
      });
    }

    if ($('#text-source').val() == 'description') {
      $.post(url, {'username1': username1,'username2': username2
        }, function(results){
        var matchscore = results.match_description;
        $('#match').html('<h3>' + name1 + ' and ' + name2 + ' is ' + matchscore  +' match in photo description' + '</h3>');
        d3.select("svg").remove();
        updateBubble("static/description.csv");
      });
    }
  }

  $('#text-source').on('change', updateGraph);
  
 function loadRecommendation(){
    url = '/tags-bubble';
    username1 = $('#matchScore').data('username1');
    username2 = $('#matchScore').data('username2');
    $.post(url, {'username1': username1, 'username2': username2},
      function(results){
        var urls = results.urls;
        var text = "";
        var i;
        for(i = 0; i < urls.length; i++){
          text += "<img src='" + urls[i] + "'></img>";
        }
        $('#recommendation').html(text);
        $('button').hide();
      });
  }

  $(document).ready(function(){
    $('button').click(function() {
      loadRecommendation();
    });
  })

    // D3 global variables
  var width = 1140,
      height = 500,
      padding = 0, // separation between same-color nodes
      clusterPadding = 0, // separation between different-color nodes
      maxRadius = 20;

  var color = d3.scale.ordinal()
        .range([ "#F9CF00", '#F19F4D', '#4484CE']);

  var opacity = d3.scale.ordinal()
        .range([0.8, 0.8, 0.8])


  //D3 function that display given textUrl
  function updateBubble(dataFilePath) {
    d3.text(dataFilePath, function(error, text) {
        if (error) throw error;

        var colNames = "word,count,user\n" + text;
        var data = d3.csv.parse(colNames);

        data.forEach(function(d) {
          d.count = +d.count;
        });

      //unique cluster/user id's
      var cs = [];
      data.forEach(function(d){
              if(!cs.contains(d.user)) {
                  cs.push(d.user);
              }
      });

      var n = data.length, // total number of nodes
          m = cs.length; // number of distinct clusters

      //create clusters and nodes
      var clusters = new Array(m);
      var nodes = [];
      for (var i = 0; i<n; i++){
          nodes.push(create_nodes(data,i));
      }

      var force = d3.layout.force()
          .nodes(nodes)
          .size([width, height])
          .gravity(0.05)
          .charge(-80)
          .on("tick", tick)
          .start();

      var svg = d3.select("#graph").append("svg");

      // svg.selectAll("*").remove();

      svg.attr("width", width)
          .attr("height", height);

      var div = d3.select("#graph").append("div") 
        .attr("class", "tooltip")       
        .style("opacity", 1);

      var node = svg.selectAll("circle")
          .data(nodes)
          .enter().append("g").call(force.drag);

      node.append("circle")
          .style("fill", function (d) {
            return color(d.cluster);
          })
          .style("opacity", function (d) {
            return opacity(d.cluster)
          })
          .attr("r", function(d){
            return d.radius * 1.2});
          
      let textNode = node.append("text")
            .attr("dy", ".3em")
            .style("text-anchor", "middle")
            // .text(function(d) {return d.word + "&#xA;" + d.count}) 
              // { return d.text.substring(0, d.radius / 3); });
      textNode.append('tspan')
            .attr("x", "0")            
            .attr("dy", "0em")
            .text(function(d) {return d.word});
 
      textNode.append('tspan')
            .attr("x", "0")
            .attr("dy", "1em")
            .text(function(d) {return d.count});

      node.on("mouseover", function(d) {     
              div.transition()   
                .duration(100)
                .attr('x', d.x)    
                .attr('y', d.y)
                .style("opacity", 1);
              div.html(d.user + "<br>" + d.word + "<br>" + d.count + " tags");                         
              })
          .on("mousemove", function() {
              div.style("top", (d3.event.pageY - 10) + "px")
                .style("left", (d3.event.pageX + 10) + "px");
            })      
          .on("mouseout", function() {   
              div.transition()   
                .duration(100)    
                .style("opacity", 0);
                // .style("visibility", "hidden");
            });

      function create_nodes(data,node_counter) {
        var i = cs.indexOf(data[node_counter].user),//return the first index
            r = Math.sqrt((i + 1) / m * -Math.log(Math.random())) * maxRadius,
            d = {
              cluster: i,
              radius: data[node_counter].count,
              text: data[node_counter].word + ':' + data[node_counter].count,
              word: data[node_counter].word,
              user: data[node_counter].user,
              count: data[node_counter].count,
              x: Math.cos(i / m * 2 * Math.PI) * 200 + width / 2 + Math.random(),
              y: Math.sin(i / m * 2 * Math.PI) * 200 + height / 2 + Math.random()
            };
        if (!clusters[i] || (r > clusters[i].radius)) clusters[i] = d;
        return d;
      };

      function tick(e) {
          node.each(cluster(2 * e.alpha * e.alpha))
              .each(collide(0.5))
          .attr("transform", function (d) {
              var k = "translate(" + d.x + "," + d.y + ")";
              return k;
          })
      }

      // Move d to be adjacent to the cluster node.
      function cluster(alpha) {
          return function (d) {
              var cluster = clusters[d.cluster];
              if (cluster === d) return;
              var x = d.x - cluster.x,
                  y = d.y - cluster.y,
                  l = Math.sqrt(x * x + y * y),
                  r = d.radius + cluster.radius;
              if (l != r) {
                  l = (l - r) / l * alpha;
                  d.x -= x *= l;
                  d.y -= y *= l;
                  cluster.x += x;
                  cluster.y += y;
              }
          };
      }

      // Resolves collisions between d and all other circles.
      function collide(alpha) {
          var quadtree = d3.geom.quadtree(nodes);
          return function (d) {
              var r = d.radius + maxRadius + Math.max(padding, clusterPadding),
                  nx1 = d.x - r,
                  nx2 = d.x + r,
                  ny1 = d.y - r,
                  ny2 = d.y + r;
              quadtree.visit(function (quad, x1, y1, x2, y2) {
                  if (quad.point && (quad.point !== d)) {
                      var x = d.x - quad.point.x,
                          y = d.y - quad.point.y,
                          l = Math.sqrt(x * x + y * y),
                          r = d.radius + quad.point.radius + (d.cluster === quad.point.cluster ? padding : clusterPadding);
                      if (l < r) {
                          l = (l - r) / l * alpha;
                          d.x -= x *= l;
                          d.y -= y *= l;
                          quad.point.x += x;
                          quad.point.y += y;
                      }
                  }
                  return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
              });
          };
      }
    });
  }

  updateGraph("static/tags.csv"); 

  Array.prototype.contains = function(v) {
    for(var i = 0; i < this.length; i++) {
        if(this[i] === v) return true;
    }
    return false;
  };

</script>

{% endblock %}




